@using System.Security.Claims

@{
    Layout = "_Layout";

    // Get the ClaimsIdentity object directly
    var claimsIdentity = User.Identity as ClaimsIdentity;

    // Declare and initialize the user's roles array
    string[]? userRoles = claimsIdentity?.Claims
                                        .Where(claim => claim.Type == ClaimTypes.Role)
                                        .Select(claim => claim.Value)
                                        .ToArray();
        string branch = claimsIdentity?.Claims
                            .FirstOrDefault(c => c.Type == "Sucursal")?.Value ?? "Unknown";
}

<!--Bootstrap Datatable-->
<link rel="stylesheet" type="text/css" href="~/Template/app-assets/vendors/css/tables/datatable/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="~/Template/app-assets/vendors/css/tables/datatable/responsive.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.3.2/css/buttons.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="~/Template/app-assets/vendors/css/tables/datatable/buttons.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="~/Template/app-assets/vendors/css/tables/datatable/rowGroup.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="~/Template/app-assets/vendors/css/forms/select/select2.min.css">
<link href="~/css/jquery.loadingmodal.css" rel="stylesheet" />

<!-- Zero configuration table -->
<section id="basic-datatable">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Factibilidades</h4>
                    <button type="button" id="addFactibilidad" name="addFactibilidad" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalAgregarFactibilidad" onclick="ResetModal()">
                        Agregar Estudio
                    </button>
                </div>
                <div class="card-content">
                    <div class="card-body card-dashboard">
                        <div class="table-responsive col-md-12">
                            <table class="table zero-configuration nowrap" id="factibilidadesTable">
                                <thead>
                                    <tr style="width:100%">
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th>
                                            @if (userRoles != null && userRoles.Contains("Admin"))
                                            {
                                                <select class="form-control" id="serviceTypeFilter">
                                                    <option value=""></option>
                                                </select>
                                            }

                                        </th>
                                        <th>
                                            @if (userRoles != null && userRoles.Contains("Admin"))
                                            {
                                                <select class="form-control" id="clientFilter">
                                                    <option value=""></option>
                                                </select>
                                            }
                                        </th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                    </tr>
                                    <tr>
                                        <th></th>
                                        @if (branch == "Guatemala - Infinitum")
                                        {
                                            <th>Oferta</th>
                                        }
                                        else
                                        {
                                            <th>Ticket</th>
                                        }
                                        <th>Detalle</th>
                                        <th>Tipo de Servicio</th>
                                        <th>Cliente</th>
                                        <th>KAM</th>
                                        <th>BW(Mbps)</th>
                                        <th>Fecha Solicitud</th>
                                        <th>Fecha Respuesta</th>
                                        <th>Estado</th>
                                        <th>Sitio Con Cobertura</th>
                                        <th>Sitio Con Cobertura Parcial</th>
                                        <th>Sitio Sin Cobertura</th>
                                        <th>Sitios analizados</th>
                                        <th>Ingeniero</th>
                                        <th>CAPEX</th>
                                        <th>OPEX</th>
                                        <th>Estado Factibilidad</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal Agregar Factibilidad -->
<div class="modal fade fade text-start" id="modalAgregarFactibilidad" tabindex="-1" role="dialog" aria-labelledby="myModalLabel33" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel33"> Agregar un Estudio </h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="ResetModal()" id="closeModalAgregarFactibilidad">
                    @* <span aria-hidden="true">&times;</span>*@
                </button>
            </div>
            <div class="modal-body">
                <form id="form-factibilidad" name="form-factibilidad" method="post">
                    <div class="modal-body">
                        <div class="col-md-12">
                            <div class="row">
                                <div class="col-md-12">
                                    <label>Detalle: </label>
                                    <div class="mb-1">
                                        <input type="text" id="Estudio" name="Estudio" placeholder="Detalle Estudio" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>@(branch == "Guatemala - Infinitum" ? "Oferta" : "Ticket"):</label>
                                    <div class="mb-1">
                                        <input type="@(branch == "Guatemala - Infinitum" ? "text" : "number")" id="Ticket" name="Ticket" placeholder="Ingrese @(branch == "Guatemala - Infinitum" ? "Oferta" : "Ticket")" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <label>Cliente: </label>
                                    <div class="input-group mb-1">
                                        <select class="form-control col-md-12" id="selectCliente" name="selectCliente">
                                            <option value="">Seleccione una opción</option>
                                        </select>
                                        <div class="input-group-append">
                                            <button class="btn btn-primary" id="btn-add-client" type="button">
                                                <i data-feather="plus-circle"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>KAM: </label>
                                    <div class="mb-1">
                                        <select class="form-control col-md-12" id="selectKAM" name="selectKAM">
                                            <option value="">Seleccione una opción</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label>BW: </label>
                                    <div class="mb-1">
                                        <input type="number" id="BW" name="BW" placeholder="Ancho de Banda" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label>Fecha Solicitud</label>
                                    <div class="mb-1">
                                        <input id="fechaSolicitud" name="fechaSolicitud" class="form-control" type="datetime-local" />
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>Fecha Respuesta</label>
                                    <div class="mb-1">
                                        <input id="fechaRespuesta" name="fechaRespuesta" class="form-control" type="datetime-local" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label>Sitios Con Cobertura: </label>
                                    <div class="mb-1">
                                        <input type="number" id="SitioConCobertura" name="SitioConCobertura" placeholder="Sitios Con Cobertura" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label>Sitios Con Cobertura Parcial: </label>
                                    <div class="mb-1">
                                        <input type="number" id="SitioConCoberturaParcial" name="SitioConCoberturaParcial" placeholder="Sitios Con Cobertura Parcial" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>Sitios Sin Cobertura:</label>
                                    <input type="number" id="SitioSinCobertura" name="SitioSinCobertura" class="form-control" placeholder="Sitios Sin Cobertura" />
                                </div>

                                <div class="col-md-4">
                                    <label>Tipo de Servicio:</label>
                                    <select id="selectTipoServicio" name="selectTipoServicio" class="form-control">
                                        <option value="">Seleccione una opción</option>
                                    </select>
                                </div>

                                @* Renderizar coordenadas solo si no es El Salvador *@
                                @if (branch != "El Salvador")
                                {
                                    <div class="col-md-4">
                                        <label>Coordenadas:</label>
                                        <input type="text" id="coordinate" name="coordinate" class="form-control" placeholder="Ej: 14.63,-90.5" />
                                    </div>
                                }

                                @* Si es El Salvador, llenar la tercera columna con CAPEX para que no quede vacía *@
                                @if (branch == "El Salvador")
                                {
                                    <div class="col-md-4">
                                        <label>CAPEX:</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" id="capex" name="capex" class="form-control" placeholder="Ej: 150000" />
                                        </div>
                                    </div>
                                }
                            </div>

                            @* Segunda fila solo si no es El Salvador *@
                            @if (branch != "El Salvador")
                            {
                                <div class="row">
                                    <div class="col-md-4">
                                        <label>Departamento:</label>
                                        <select id="selectState" name="selectState" class="form-control">
                                            <option value="">Seleccione una opción</option>
                                        </select>
                                    </div>

                                    <div class="col-md-4">
                                        <label>Municipio:</label>
                                        <select id="selectMunicipality" name="selectMunicipality" class="form-control">
                                            <option value="">Seleccione una opción</option>
                                        </select>
                                    </div>

                                    <div class="col-md-4">
                                        <label>CAPEX:</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" id="capex" name="capex" class="form-control" placeholder="Ej: 150000" />
                                        </div>
                                    </div>
                                </div>
                            }

                            @* OPEX siempre en fila nueva *@
                            <div class="row">
                                <div class="col-md-4">
                                    <label>OPEX:</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" id="opex" name="opex" class="form-control" placeholder="Ej: 150000" />
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" id="btnGuardarFactibilidad">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Modal Agregar Factibilidad Fin -->

<!-- Modal Editar Factibilidad -->
<div class="modal fade text-start" id="modalEditarFactibilidad" tabindex="-1" role="dialog" aria-labelledby="myModalLabel33" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel33"> Editar un Estudio </h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="ResetModal()" id="closeModalEditarFactibilidad"></button>
            </div>
            <div class="modal-body">
                <form id="form-factibilidade" name="form-factibilidade" method="post">
                    <div class="modal-body">
                        <input type="hidden" id="IdFactibilidade" name="IdFactibilidade" class="form-control">
                        <div class="col-md-12">
                            <div class="row">
                                <div class="col-md-12">
                                    <label>Detalle: </label>
                                    <div class="mb-1">
                                        <input type="text" id="Estudioe" name="Estudioe" placeholder="Detalle Estudio" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>@(branch == "Prueba" ? "Oferta" : "Ticket"):</label>
                                    <div class="mb-1">
                                        <input type="@(branch == "Prueba" ? "text" : "number")" id="Tickete" name="Tickete" placeholder="Ingrese @(branch == "Prueba" ? "Oferta" : "Ticket")" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <label>Cliente: </label>
                                    <div class="input-group mb-1">
                                        <select class="form-control col-md-12" id="selectClientee" name="selectClientee">
                                            <option value="">Seleccione una opción</option>
                                        </select>
                                        <div class="input-group-append">
                                            <button class="btn btn-primary" id="btn-add-cliente" type="button">
                                                <i data-feather="plus-circle"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>KAM: </label>
                                    <div class="mb-1">
                                        <select class="form-control col-md-12" id="selectKAMe" name="selectKAMe">
                                            <option value="">Seleccione una opción</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label>BW: </label>
                                    <div class="mb-1">
                                        <input type="number" id="BWe" name="BWe" placeholder="Ancho de Banda" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label>Fecha Solicitud</label>
                                    <div class="mb-1">
                                        <input id="fechaSolicitude" name="fechaSolicitude" class="form-control" type="datetime-local" />
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>Fecha Respuesta</label>
                                    <div class="mb-1">
                                        <input id="fechaRespuestae" name="fechaRespuestae" class="form-control" type="datetime-local" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label>Sitios Con Cobertura: </label>
                                    <div class="mb-1">
                                        <input type="number" id="SitioConCoberturae" name="SitioConCoberturae" placeholder="Sitios Con Cobertura" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label>Sitios Con Cobertura Parcial: </label>
                                    <div class="mb-1">
                                        <input type="number" id="SitioConCoberturaParciale" name="SitioConCoberturaParciale" placeholder="Sitios Con Cobertura Parcial" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>Sitios Sin Cobertura:</label>
                                    <div class="mb-1">
                                        <input type="number" id="SitioSinCoberturae" name="SitioSinCoberturae" class="form-control" placeholder="Sitios Sin Cobertura" />
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <label>Tipo de Servicio:</label>
                                    <div class="mb-1">
                                        <select id="selectTipoServicioe" name="selectTipoServicioe" class="form-control">
                                            <option value="">Seleccione una opción</option>
                                        </select>
                                    </div>
                                </div>

                                @* Coordenadas solo si no es El Salvador *@
                                @if (branch != "El Salvador")
                                {
                                    <div class="col-md-4">
                                        <label>Coordenadas:</label>
                                        <div class="mb-1">
                                            <input type="text"
                                                id="coordinatee"
                                                name="coordinatee"
                                                class="form-control"
                                                placeholder="Ej: 14.63,-90.5"
                                                pattern="^-?\d{1,2}(\.\d+)?,\s*-?\d{1,3}(\.\d+)?$"
                                                title="Ingrese coordenadas válidas en formato: latitud,longitud. Ej: 14.63,-90.5" />
                                            <div class="invalid-feedback">
                                                Por favor ingrese coordenadas válidas (latitud entre -90 y 90, longitud entre -180 y 180).
                                            </div>
                                        </div>
                                    </div>
                                }

                                @* Si es El Salvador, llenar tercera columna con CAPEX para que no queden espacios *@
                                @if (branch == "El Salvador")
                                {
                                    <div class="col-md-4">
                                        <label>CAPEX:</label>
                                        <div class="input-group mb-1">
                                            <span class="input-group-text">$</span>
                                            <input type="number"
                                                id="capexe"
                                                name="capexe"
                                                class="form-control"
                                                placeholder="Ej: 150000"
                                                min="0"
                                                step="0.01"
                                                title="Ingrese un valor numérico para el CAPEX">
                                            <div class="invalid-feedback">
                                                Por favor ingrese un valor válido para el CAPEX.
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>

                            @* Segunda fila solo si no es El Salvador *@
                            @if (branch != "El Salvador")
                            {
                                <div class="row">
                                    <div class="col-md-4">
                                        <label>Departamento:</label>
                                        <div class="mb-1">
                                            <select id="selectStatee" name="selectStatee" class="form-control">
                                                <option value="">Seleccione una opción</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <label>Municipio:</label>
                                        <div class="mb-1">
                                            <select id="selectMunicipalitye" name="selectMunicipalitye" class="form-control">
                                                <option value="">Seleccione una opción</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <label>CAPEX:</label>
                                        <div class="input-group mb-1">
                                            <span class="input-group-text">$</span>
                                            <input type="number"
                                                id="capexe"
                                                name="capexe"
                                                class="form-control"
                                                placeholder="Ej: 150000"
                                                min="0"
                                                step="0.01"
                                                title="Ingrese un valor numérico para el CAPEX">
                                            <div class="invalid-feedback">
                                                Por favor ingrese un valor válido para el CAPEX.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                            @* OPEX siempre en fila nueva *@
                            <div class="row">
                                <div class="col-md-4">
                                    <label>OPEX:</label>
                                    <div class="input-group mb-1">
                                        <span class="input-group-text">$</span>
                                        <input type="number"
                                            id="opexe"
                                            name="opexe"
                                            class="form-control"
                                            placeholder="Ej: 150000"
                                            min="0"
                                            step="0.01"
                                            title="Ingrese un valor numérico para el OPEX">
                                        <div class="invalid-feedback">
                                            Por favor ingrese un valor válido para el OPEX.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" id="btnEditarFactibilidad">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Modal Editar Factibilidad Fin -->

<!-- Modal Agregar Cliente -->
<div class="modal fade fade text-start" id="modalAgregarCliente" tabindex="-1" role="dialog" aria-labelledby="myModalLabel33" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel33"> Agregar Cliente </h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="ResetModal()" id="closeModalAgregarCliente">
                    @* <span aria-hidden="true">&times;</span>*@
                </button>
            </div>
            <div class="modal-body">
                <form id="form-add-client" name="form-add-client" method="post">
                    <div class="modal-body">
                        <div class="col-md-12">
                            <div class="row">
                                <div class="col-md-12">
                                    <label>Nombre Cliente: </label>
                                    <div class="mb-1">
                                        <input type="text" id="addClientInput" name="addClientInput" placeholder="Agregar Cliente" class="form-control">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" id="btn-save-client">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Modal Agregar Cliente Fin -->

<!-- Modal Aprobar Rechazar -->
<div class="modal fade" id="modalApproveReject" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Validar Factibilidad</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>¿Desea aprobar o rechazar la factibilidad <strong id="modalTicket"></strong>?</p>
        <textarea id="modalComment" class="form-control" placeholder="Comentario opcional"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="btnReject">Rechazar</button>
        <button type="button" class="btn btn-success" id="btnApprove">Aprobar</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal Aprobar Rechazar Fin-->

@section Scripts {
    <!-- Bootstrap datatable -->
    <script src="~/Template/app-assets/vendors/js/tables/datatable/jquery.dataTables.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/dataTables.bootstrap5.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/dataTables.responsive.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/responsive.bootstrap5.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/datatables.checkboxes.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/datatables.buttons.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/jszip.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/pdfmake.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/vfs_fonts.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/buttons.html5.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/buttons.print.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/dataTables.rowGroup.min.js"></script>
    <!-- end Bootstrap datatable -->
    <script src="~/Template/app-assets/vendors/js/forms/select/select2.full.min.js"></script>
    <script src="~/Template/app-assets/js/scripts/forms/form-select2.js"></script>
    <script src="~/Template/app-assets/vendors/js/forms/validation/jquery.validate.min.js"></script>
    <!-- Mensaje cargando-->
    <script src="~/js/jquery.loadingModal.js"></script>
    <!-- Alertas-->
    <script src="~/js/sweetalert2.all.min.js"></script>

    <script>
        let idFactibilitySelected;
        let selectedTicket;

        $(document).ready(function () {

            $('#factibilidadesTable').DataTable({
                "language": { "url": "https://cdn.datatables.net/plug-ins/1.12.1/i18n/es-ES.json" },
                processing: true,
                serverSide: true,
                searching: true,
                ordering: true,
                paging: true,
                lengthMenu: [
                    [10, 25, 50, 100, -1],
                    ['10', '25', '50', '100', 'Todo']
                ],
                "ajax": {
                    "url": "@Url.Action("ListaFactibilidadesPaginate", "Indicadores")",
                    "type": "POST",
                    "dataType": "json"
                },
                "order": [[0, "desc"]],
                dom: 'lBfrtip',
                "buttons": [
                    {
                        extend: 'excel',
                        className: 'btn btn-success',
                        action: function (e, dt, node, config) {
                            exportExcel(); 
                        }
                    }
                ],
                columns: [
                    { "data": "idFactibilidad", "visible": false },
                    { "data": "ticket" },
                    { "data": "estudio" },
                    { "data": "tipoServicio" },
                    { "data": "cliente" },
                    { "data": "kam" },
                    { "data": "bw", render: $.fn.dataTable.render.number( ',', '.', 0)},
                    { "data": "fechaSolicitud" },
                    { "data": "fechaRespuesta" },
                    { "data": "estado" },
                    { "data": "sitioConCobertura" },
                    { "data": "sitioConCoberturaParcial" },
                    { "data": "sitioSinCobertura" },
                    { "data": "sitiosAnalizados" },
                    { "data": "ingeniero" },
                    {
                        data: "capex",
                        render: function(data, type, row) {
                            if (type === 'display') {
                                return data != null ? $.fn.dataTable.render.number(',', '.', 2).display(data) : '';
                            }
                            // Para sort/filtro, los nulos se colocan al final
                            return data != null ? parseFloat(data) : Number.MAX_SAFE_INTEGER;
                        }
                    },
                    {
                        data: "opex",
                        render: function(data, type, row) {
                            if (type === 'display') {
                                return data != null ? $.fn.dataTable.render.number(',', '.', 2).display(data) : '';
                            }
                            // Para sort/filtro, los nulos se colocan al final
                            return data != null ? parseFloat(data) : Number.MAX_SAFE_INTEGER;
                        }
                    },
                    { "data": "estadoFactibilidad" },
                    {
                        'defaultContent': null,
                        'render': function (data, type, row) {
                            return `
                                <div class="d-flex">
                                    <button type="button" class="btn btn-icon btn-warning mx-1" 
                                            id="${row.idFactibilidad}" 
                                            onclick="detallesFactibilidad(this.id)" 
                                            data-toggle="tooltip" data-placement="left" title="Modificar">
                                        <i data-feather="edit"></i>
                                    </button>

                                    <button type="button" class="btn btn-icon btn-danger mx-1" 
                                            id="${row.idFactibilidad}" 
                                            onclick="eliminarFactibilidad(this.id)" 
                                            data-toggle="tooltip" data-placement="left" title="Eliminar">
                                        <i data-feather="trash"></i>
                                    </button>

                                    @if (userRoles != null && userRoles.Contains("Comercial"))
                                    {
                                        <button class="btn btn-icon btn-primary mx-1" 
                                                onclick="validateFactibility('${row.idFactibilidad}','${row.ticket}')"
                                                data-toggle="tooltip" title="Validar"
                                                ${row.estadoFactibilidad === "Aprobado" || row.estadoFactibilidad === "Rechazado" ? "disabled" : ""}>
                                            <i data-feather="check-square"></i>
                                        </button>
                                    }

                                </div>
                            `;
                        }
                    }
                ],
                rowCallback: function (row, data) {
                    if (data.estado === 'Activo') {
                        $($(row).find("td")[8]).css("color", "green");
                    }
                    else {
                        $($(row).find("td")[8]).css("color", "#E60026");
                    }
                    //Colocar color a Sitios
                    //Sitios Con Cobertura
                    $($(row).find("td")[9]).css("color", "#43F30B");
                    //Sitios Con Cobertura Parcial
                    $($(row).find("td")[10]).css("color", "#F8E207");
                    //Sitios Sin Cobertura
                    $($(row).find("td")[11]).css("color", "#F80719");
                    //Sitios Totales
                    $($(row).find("td")[12]).css("color", "#DE07F8");
                    //Color a CAPEX y OPEX
                    $($(row).find("td")[14]).css("color", "#43F30B");
                    $($(row).find("td")[15]).css("color", "#43F30B");

                    //Colocar Estilo a Estado de Factibilidad   
                    let statusCol = 16;  // columna del estado
                    let statusClass = '';
                    let statusStyle = '';

                    switch(data.estadoFactibilidad) {
                        case 'Creado':
                            statusStyle = 'background-color:#FFD966; color:#000000'; 
                            break;
                        case 'Aprobado':
                            statusClass = 'bg-success text-white';
                            break;
                        case 'Rechazado':
                            statusClass = 'bg-danger text-white';
                            break;
                        default:
                            statusClass = 'bg-secondary text-white';
                    }

                    let statusBadge = `<div class="text-center">
                                        <span class="badge ${statusClass}" style="${statusStyle}">
                                            ${data.estadoFactibilidad ?? ""}
                                        </span>
                                    </div>`;

                    $($(row).find("td")[statusCol]).html(statusBadge);

                },
                drawCallback: function (settings) {
                    feather.replace();
                },
                initComplete: function () {
                    var api = this.api();

                    // Obtener el objeto de respuesta JSON
                    var jsonResponse = api.ajax.json();

                    // Crear el filtro desplegable para la columna "Tipo de Servicio"
                    var serviceTypeFilterValues = jsonResponse.filtersValues[0];

                    // Limpiar y llenar el filtro desplegable con valores únicos
                    $('#serviceTypeFilter').empty();
                    $('#serviceTypeFilter').append('<option value=""></option>');
                    serviceTypeFilterValues.forEach(function (value) {
                        $('#serviceTypeFilter').append('<option value="' + value.tipoServicio1 + '">' + value.tipoServicio1 + '</option>');
                    });

                    // Crear el filtro desplegable para la columna "Clientes"
                    var clientFilterValues = jsonResponse.filtersValues[1];

                    // Limpiar y llenar el filtro desplegable con valores únicos
                    $('#clientFilter').empty();
                    $('#clientFilter').append('<option value=""></option>');
                    clientFilterValues.forEach(function (value) {
                        $('#clientFilter').append('<option value="' + value.nombre + '">' + value.nombre + '</option>');
                    });

                    // Agregar el evento de cambio al filtro desplegable
                    $('#serviceTypeFilter').on('change', function () {
                        var val = $.fn.dataTable.util.escapeRegex($(this).val());
                        api.column(3).search(val ? val  : '', true, false).draw();
                    });

                    // Agregar el evento de cambio al filtro desplegable
                    $('#clientFilter').on('change', function () {
                        var val = $.fn.dataTable.util.escapeRegex($(this).val());
                        api.column(4).search(val ? val : '', true, false).draw();
                    });
                }

            });

            cargarSelect();
            loadSelects();
        });

        function cargarSelect() {
            //Clientes
            $.get("@Url.Action("selectClientes","Indicadores")", function (data) {

                $("#selectCliente").empty();
                $("#selectClientee").empty();

                $.each(data, function (index, row) {
                    $("#selectCliente").append("<option value='" + row.idCliente + "'>" + row.nombre + "</option>");
                    $("#selectClientee").append("<option value='" + row.idCliente + "'>" + row.nombre + "</option>")

                });
                $("#selectCliente").append("<option selected disabled hidden value='0'>" + "Por Favor Seleccione cliente" + "</option>");
            });

            //KAMs
            $.get("@Url.Action("selectKAM","Indicadores")", function (data) {

                $("#selectKAM").empty();
                $("#selectKAMe").empty();

                $.each(data, function (index, row) {
                    $("#selectKAM").append("<option value='" + row.idKAM + "'>" + row.nombre + "</option>");
                    $("#selectKAMe").append("<option value='" + row.idKAM + "'>" + row.nombre + "</option>")

                });
                $("#selectKAM").append("<option selected disabled hidden value='0'>" + "Por Favor Seleccione KAM" + "</option>");
            });

            //Tipos de Servicio
            $.get("@Url.Action("selectTiposServicios","Indicadores")", function (data) {

                $("#selectTipoServicio").empty();
                $("#selectTipoServicioe").empty();

                $.each(data, function (index, row) {
                    $("#selectTipoServicio").append("<option value='" + row.idTipoServicio+ "'>" + row.tipoServicio + "</option>");
                    $("#selectTipoServicioe").append("<option value='" + row.idTipoServicio + "'>" + row.tipoServicio + "</option>")

                });
                $("#selectTipoServicio").append("<option selected disabled hidden value='0'>" + "Por Favor Seleccione Tipo Servicio" + "</option>");
            });

        }

        function loadSelects() {
            // Definir un array de objetos con la información de cada select
            var selects = [
                { id: "selectState", entityName: "State", valueField: "IdState", textField: "Name" },
                { id: "selectStatee", entityName: "State", valueField: "IdState", textField: "Name" },                   
            ];

            // Iterar sobre cada select y cargarlo
            selects.forEach(function (select) {
                loadSelectById(select.id, select.entityName, select.valueField, select.textField)
                    .then(function () {
                        if (typeof select.load === "function") {
                            select.load(); // Ejecutar la función de carga personalizada si está definida
                        }
                    })
                    .catch(function (error) {
                        console.error("Error al cargar el select " + select.id + ":", error);
                    });
            });
        }
        
        //Carga el select de manera dinamica pasando id, entidad, valor id, valor descripcion
        function loadSelectById(elementId, entityName, valueField, textField) {
            return new Promise(function (resolve, reject) {
                $.ajax({
                    url: "@Url.Action("GetSelectListItems", "Common")",
                    type: 'GET',
                    data: {
                        entityName: entityName,
                        valueField: valueField,
                        textField: textField
                    },
                    dataType: 'json',
                    success: function (response) {
                        $('#' + elementId).empty();
                        $('#' + elementId).append($('<option>', {
                            value: '',
                            text: '-- Seleccione un item --'
                        }));
                        $.each(response, function (index, item) {
                            $('#' + elementId).append($('<option>', {
                                value: item.value,
                                text: item.text
                            }));
                        });
                        resolve(); // Resuelve la promesa cuando la carga se completa exitosamente
                    },
                    error: function (error) {
                        console.error('Error al obtener los elementos del DropDownList:', error);
                        reject(error); // Rechaza la promesa si hay un error
                    }
                });
            });
        }
        
        //VALIDACION DE FORMULARIOS

        $("#form-factibilidad").validate({
            rules: {
                Estudio: "required",
                Ticket: "required",
                selectCliente: "required",
                selectKAM: "required",
                BW: "required",
                fechaSolicitud: "required",
                fechaRespuesta: "required",
                SitioConCobertura: "required",
                SitioConCoberturaParcial: "required",
                SitioSinCobertura: "required",
                selectTipoServicio: "required"
            },
            messages: {
                Estudio: "Ingrese Detalle",
                Ticket: "Ingrese Ticket",
                selectCliente: "Seleccione Cliente",
                selectKAM: "Seleccione KAM",
                BW: "Ingrese BW",
                fechaSolicitud: "Seleccione Fecha Solicitud",
                fechaRespuesta: "Seleccione Fecha Respuesta",
                SitioConCobertura: "Ingrese Sitios CC",
                SitioConCoberturaParcial: "Ingrese Sitios CCP",
                SitioSinCobertura: "Ingrese Sitios SC",
                selectTipoServicio: "Ingrese Tipo servicio"
            },
            submitHandler: function (form) {
                event.preventDefault();
                agregarFactibilidad();
            }
        });

        $("#form-factibilidade").validate({
            ignore: [],
            rules: {
                Estudioe: "required",
                Tickete: "required",
                selectClientee: "required",
                selectKAMe: "required",
                BWe: "required",
                fechaSolicitude: "required",
                fechaRespuestae: "required",
                SitioConCoberturae: "required",
                SitioConCoberturaParciale: "required",
                SitioSinCoberturae: "required",
                selectTipoServicioe: "required"
            },
            messages: {
                Estudioe: "Ingrese Detalle",
                Tickete: "Ingrese Ticket",
                selectClientee: "Seleccione Cliente",
                selectKAMe: "Seleccione KAM",
                BWe: "Ingrese BW",
                fechaSolicitude: "Seleccione Fecha Solicitud",
                fechaRespuestae: "Seleccione Fecha Respuesta",
                SitioConCoberturae: "Ingrese Sitios CC",
                SitioConCoberturaParciale: "Ingrese Sitios CCP",
                SitioSinCoberturae: "Ingrese Sitios SC",
                selectTipoServicioe: "Ingrese Tipo servicio"
            },
            submitHandler: function (form) {
                event.preventDefault();
                editarFactibilidad();
            }
        });

        $("#form-add-client").validate({
            ignore: [],
            rules: {
                addClientInput: "required"
            },
            messages: {
                addClientInput: "Ingrese Nombre"
            },
            submitHandler: function (form) {
                event.preventDefault();
                addClient();
            }
        });

        //EVENTOS
        $("#btn-add-client").on("click", function () {
            $("#modalAgregarCliente").modal("show");
        });

        $("#btn-add-cliente").on("click", function () {
            $("#modalAgregarCliente").modal("show");
        });

        $("#selectState").on('change', function () {
            let selectedItem = $(this).val();
            if (selectedItem > 0) {
                loadMunicipalitySelectByState("selectMunicipality", selectedItem);
            }
        });

        $("#selectStatee").on('change', function () {
            let selectedItem = $(this).val();
            if (selectedItem > 0) {
                loadMunicipalitySelectByState("selectMunicipalitye", selectedItem);
            }
        });

       $('#btnApprove').off('click').on('click', function () {
            let comment = $('#modalComment').val();

            approveFactibility(idFactibilitySelected, selectedTicket, comment);

            $('#modalApproveReject').modal('hide');
        });

        $('#btnReject').off('click').on('click', function () {
            let comment = $('#modalComment').val();

            rejectFactibility(idFactibilitySelected, selectedTicket, comment);

            $('#modalApproveReject').modal('hide');
        });

        //FUNCIONES

        function ResetModal() {
            var validator = $("#modalAgregarFactibilidad").validate();
            validator.resetForm();
            $("#Estudio").val("");
            $("#Ticket").val("");
            $("#selectCliente").val(0);
            $("#selectKAM").val(0);
            $("#BW").val("");
            $("#fechaSolicitud").val("");
            $("#fechaRespuesta").val("");
            $("#SitioConCobertura").val("");
            $("#SitioConCoberturaParcial").val("");
            $("#SitioSinCobertura").val("");
            $("#selectTipoServicio").val(0);
            $("#coordinate").val("");
            $("#capex").val("");
            $("#opex").val("");
            $("#selectMunicipality").val("");
            $("#selectState").val("");
        }

        function ResetModalEditar() {
            var validator = $("#modalEditarFactibilidad").validate();
            validator.resetForm();
            $("#Estudioe").val("");
            $("#Tickete").val("");
            $("#selectClientee").val(0);
            $("#selectKAMe").val(0);
            $("#BWe").val("");
            $("#fechaSolicitude").val("");
            $("#fechaRespuestae").val("");
            $("#SitioConCoberturae").val("");
            $("#SitioConCoberturaParciale").val("");
            $("#SitioSinCoberturae").val("");
            $("#selectTipoServicioe").val(0);
            $("#coordinatee").val("");
            $("#capexe").val("");
            $("#opexe").val("");
            $("#selectMunicipalitye").val("");
            $("#selectStatee").val("");
        }

        function agregarFactibilidad() {
            //mensaje carga
            $('body').loadingModal({
                position: 'auto',
                text: 'Cargando',
                color: '#fff',
                opacity: '0.7',
                backgrundColor: 'rgb(0,0,0)',
                animation: 'doubleBounce'
            });

            //objeto
            var estudio = $("#Estudio").val();
            var ticket = $("#Ticket").val();
            var cliente = $("#selectCliente").val();
            var kam = $("#selectKAM").val();
            var bw = $("#BW").val();
            var fechaSolicitud = $("#fechaSolicitud").val();
            var fechaRespuesta = $("#fechaRespuesta").val();
            var sitioConCobertura = $("#SitioConCobertura").val();
            var sitioConCoberturaParcial = $("#SitioConCoberturaParcial").val();
            var sitioSinCobertura = $("#SitioSinCobertura").val();
            var tipoServicio = $("#selectTipoServicio").val();
            var coordinate = $("#coordinate").val();
            var municipality = $("#selectMunicipality").val();
            var state = $("#selectState").val();
            var capex = $("#capex").val();
            var opex = $("#opex").val();

            var parametros = JSON.stringify({ 
                Estudio: estudio, 
                Ticket: ticket,
                Cliente: cliente,
                KAM: kam,
                BW: bw,
                FechaSolicitud: fechaSolicitud,
                FechaRespuesta: fechaRespuesta,
                SitioConCobertura : sitioConCobertura,
                SitioConCoberturaParcial: sitioConCoberturaParcial,
                SitioSinCobertura: sitioSinCobertura,
                IdTipoServicio: tipoServicio,
                Coordinate: coordinate,
                IdMunicipality: municipality, 
                IdState: state,
                Capex: capex,       
                Opex: opex
            });

            $.ajax({
                url: "@Url.Action("CrearFactibilidad", "Indicadores")",
                type: "POST",
                contentType: "application/json; charset=utf-8",
                data: parametros,
                dataType: "json",
                success: function (result) {
                    //show Alert
                    Swal.fire({
                        title: 'Crear Factibilidad',
                        text: result.mensaje,
                        icon: result.tipo
                    })
                    //$("#modalAgregarUsuario").modal('hide');
                    $('#closeModalAgregarFactibilidad').trigger("click");

                    //reload table
                    var table = $('#factibilidadesTable').DataTable();
                    table.ajax.reload();
                    //hidemodal loading
                    $('body').loadingModal('destroy');
                },
                error: function (result) {
                    Swal.fire({
                        title: 'Crear Factibilidad',
                        text: result.Mensaje,
                        icon: result.Tipo
                    })
                    //hidemodal loading
                    $('body').loadingModal('destroy');

                }
            });
        }

        function detallesFactibilidad(id) {
            //Modal Loading
            $('body').loadingModal({
                position: 'auto',
                text: 'Cargando',
                color: '#fff',
                opacity: '0.7',
                backgrundColor: 'rgb(0,0,0)',
                animation: 'doubleBounce'
            });

            $.ajax({
                url: "@Url.Action("DetallesFactibilidad", "Indicadores")",
                type: "POST",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify({ IdFactibilidad: id }),
                success: function (result) {

                    $("#IdFactibilidade").val(result.idFactibilidad);
                    $("#Estudioe").val(result.estudio);
                    $("#Tickete").val(result.ticket);
                    $("#selectClientee").val(result.idCliente);
                    $("#selectKAMe").val(result.idKAM);
                    $("#BWe").val(result.bw);
                    $("#fechaSolicitude").val(result.fechaSolicitud);
                    $("#fechaRespuestae").val(result.fechaRespuesta);
                    $("#SitioConCoberturae").val(result.sitioConCobertura);
                    $("#SitioConCoberturaParciale").val(result.sitioConCoberturaParcial);
                    $("#SitioSinCoberturae").val(result.sitioSinCobertura);
                    $("#selectTipoServicioe").val(result.idTipoServicio);
                    $("#coordinatee").val(result.coordenada);
                    $("#selectMunicipalitye").val(result.idMunicipio);
                    loadMunicipalitySelectByStateAsync("selectMunicipalitye", result.idDepartamento)
                            .then(function () {
                                $("#selectMunicipalitye").val(result.idMunicipio);
                            });
                    $("#selectStatee").val(result.idDepartamento);
                    $("#capexe").val(result.capex);
                    $("#opexe").val(result.opex);

                    $("#modalEditarFactibilidad").modal("show")

                    $('body').loadingModal('destroy');
                },
                error: function (result) {
                    //show Alert
                    Swal.fire({
                        title: "HA OCURRIDO UN ERROR",
                        text: "Error en el Servidor" + result.responseText,
                        icon: "error"
                    })
                    //hidemodal loading
                    $('body').loadingModal('destroy');

                }
            });
        }

        function editarFactibilidad() {
            //mensaje carga
            $('body').loadingModal({
                position: 'auto',
                text: 'Cargando',
                color: '#fff',
                opacity: '0.7',
                backgrundColor: 'rgb(0,0,0)',
                animation: 'doubleBounce'
            });

            //objeto
            var id = $("#IdFactibilidade").val();
            var estudio = $("#Estudioe").val();
            var ticket = $("#Tickete").val();
            var cliente = $("#selectClientee").val();
            var kam = $("#selectKAMe").val();
            var bw = $("#BWe").val();
            var fechaSolicitud = $("#fechaSolicitude").val();
            var fechaRespuesta = $("#fechaRespuestae").val();
            var sitioConCobertura = $("#SitioConCoberturae").val();
            var sitioConCoberturaParcial = $("#SitioConCoberturaParciale").val();
            var sitioSinCobertura = $("#SitioSinCoberturae").val();
            var tipoServicio = $("#selectTipoServicioe").val();
            let coordinate = $("#coordinatee").val();
            let municipality = $("#selectMunicipalitye").val();
            let state = $("#selectStatee").val();
            let capex = $("#capexe").val();
            let opex = $("#opexe").val();

            var parametros = JSON.stringify({ 
                IdFactibilidad: id, 
                Estudio: estudio, 
                Ticket: ticket,
                Cliente: cliente,
                KAM: kam,
                BW: bw,
                FechaSolicitud: fechaSolicitud,
                FechaRespuesta: fechaRespuesta,
                SitioConCobertura : sitioConCobertura,
                SitioConCoberturaParcial: sitioConCoberturaParcial,
                SitioSinCobertura: sitioSinCobertura,
                IdTipoServicio: tipoServicio,
                Coordinate: coordinate,
                IdMunicipality: municipality, 
                IdState: state,
                Capex: capex,       
                Opex: opex
            });

            $.ajax({
                url: "@Url.Action("EditarFactibilidad", "Indicadores")",
                type: "POST",
                contentType: "application/json; charset=utf-8",
                data: parametros,
                dataType: "json",
                success: function (result) {
                    //show Alert
                    Swal.fire({
                        title: 'Editar Factibilidad',
                        text: result.mensaje,
                        icon: result.tipo
                    })
                    //$("#modalAgregarUsuario").modal('hide');
                    $('#closeModalEditarFactibilidad').trigger("click");

                    //reload table
                    var table = $('#factibilidadesTable').DataTable();
                    table.ajax.reload();
                    //hidemodal loading
                    $('body').loadingModal('destroy');
                },
                error: function (result) {
                    Swal.fire({
                        title: 'Editar Factibilidad',
                        text: result.Mensaje,
                        icon: result.Tipo
                    })
                    //hidemodal loading
                    $('body').loadingModal('destroy');

                }
            });
        }

         function eliminarFactibilidad(id) {
            Swal.fire({
                title: "¿DESACTIVAR FACTIBILIDAD?",
                text: "¿Está seguro que desea desactivar esta factibilidad? con Id "+ id,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Si, Desactivar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    //Modal Loading
                    $('body').loadingModal({
                        position: 'auto',
                        text: 'Cargando',
                        color: '#fff',
                        opacity: '0.7',
                        backgrundColor: 'rgb(0,0,0)',
                        animation: 'doubleBounce'
                    });

                    $.ajax({
                        url: "@Url.Action("DesactivarFactibilidad","Indicadores")",
                        type: "POST",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: JSON.stringify({ IdFactibilidad: id }),
                        success: function (result) {
                            //show Alert
                            Swal.fire({
                                title: 'DESACTIVAR FACTIBILIDAD',
                                text: result.mensaje,
                                icon: result.tipo
                            })

                            //reload table
                            var table = $('#factibilidadesTable').DataTable();
                            table.ajax.reload();
                            //hidemodal loading
                            $('body').loadingModal('destroy');
                        },
                        error: function (result) {
                            //show Alert
                            Swal.fire({
                                title: "HA OCURRIDO UN ERROR",
                                text: "Error en el Servidor" + result.responseText,
                                icon: "error"
                            })
                            //hidemodal loading
                            $('body').loadingModal('destroy');

                        }
                    });

                }
            });
        }

        function addClient() {
            //Modal Loading
            $('body').loadingModal({
                position: 'auto',
                text: 'Cargando',
                color: '#fff',
                opacity: '0.7',
                backgrundColor: 'rgb(0,0,0)',
                animation: 'doubleBounce'
            });


            $.ajax({
                url: "@Url.Action("AddClient", "Indicadores")",
                type: 'POST',
                data: {
                    clientName: $("#addClientInput").val()
                },
                dataType: 'json',
                success: function (response) {
                    if (response) {
                        $("#modalAgregarCliente").modal("hide");
                        $("#addClientInput").val("");
                        cargarSelect();
                    } 
                    $('body').loadingModal('destroy');
                },
                error: function (xhr, status, error) {
                    $('body').loadingModal('destroy');
                }
            });
        }

        function getFileName() {
            var currentDate = new Date();
            var year = currentDate.getFullYear();
            var month = (currentDate.getMonth() + 1).toString().padStart(2, '0'); // Asegura que siempre tenga dos dígitos
            var day = currentDate.getDate().toString().padStart(2, '0');
            var hours = currentDate.getHours().toString().padStart(2, '0');
            var minutes = currentDate.getMinutes().toString().padStart(2, '0');
            var seconds = currentDate.getSeconds().toString().padStart(2, '0');

            var filename = 'factibilidades_' + year + month + day + '_' + hours + minutes + seconds + '.xlsx';
            return filename;
        }

        function exportExcel() {
            // Realizar la solicitud AJAX para descargar el archivo
            $.ajax({
                url: "@Url.Action("ExportExcelFactibilities", "Indicadores")",
                type: 'POST',
                xhrFields: {
                    responseType: 'blob' // Especificamos que esperamos un blob como respuesta
                },
                success: function (blob, textStatus, xhr) { // Aquí recibimos el blob y el objeto xhr
                    const url = window.URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = getFileName();
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    Swal.fire({
                        title: "HA OCURRIDO UN ERROR",
                        text: "Error en la descarga" + errorThrown,
                        icon: "error"
                    })
                }
            });
        }

        /**
         * Evento input en coordenadas
         */
        $('#coordinate').on('input', function () {
            const coord = $(this).val().trim();
            const regex = /^-?([1-8]?\d(\.\d+)?|90(\.0+)?),\s*-?(1[0-7]\d(\.\d+)?|180(\.0+)?|(\d{1,2}(\.\d+)?))$/;

            if (regex.test(coord)) {
                $(this).removeClass('is-invalid').addClass('is-valid');
            } else {
                // Coordenada inválida
                $(this).removeClass('is-valid').addClass('is-invalid');
            }
        });

        /**
         * Evento input en coordenadas
         */
        $('#coordinatee').on('input', function () {
            const coord = $(this).val().trim();
            const regex = /^-?([1-8]?\d(\.\d+)?|90(\.0+)?),\s*-?(1[0-7]\d(\.\d+)?|180(\.0+)?|(\d{1,2}(\.\d+)?))$/;

            if (regex.test(coord)) {
                $(this).removeClass('is-invalid').addClass('is-valid');
            } else {
                // Coordenada inválida
                $(this).removeClass('is-valid').addClass('is-invalid');
            }
        });

        /**
         * Evento blur coordenadas
         */
        $('#coordinate').on('blur', function () {
            let coordinateText = $(this).val().trim();

            let parts = coordinateText.split(',');

            let regex = /^-?\d{1,2}(\.\d+)?,\s*-?\d{1,3}(\.\d+)?$/;

            if (!regex.test(coordinateText)) {  // Cambié para validar el texto completo, no el array 'parts'
                updateAndShowToast("Coordenadas inválidas", "Ahora", "Por favor ingrese coordenadas válidas como: 14.63,-90.5");
                $(this).val('');  // Limpia pero NO pones focus otra vez
                return;
            }

            let latitude = parseFloat(parts[0]);
            let longitude = parseFloat(parts[1]);

            getMunicipalityAndDepartmentByCoordinates(latitude, longitude);
        });

        /**
         * Evento blur coordenadas
         */
        $('#coordinatee').on('blur', function () {
            let coordinateText = $(this).val().trim();

            let parts = coordinateText.split(',');

            let regex = /^-?\d{1,2}(\.\d+)?,\s*-?\d{1,3}(\.\d+)?$/;

            if (!regex.test(coordinateText)) {  // Cambié para validar el texto completo, no el array 'parts'
                updateAndShowToast("Coordenadas inválidas", "Ahora", "Por favor ingrese coordenadas válidas como: 14.63,-90.5");
                $(this).val('');  // Limpia pero NO pones focus otra vez
                return;
            }

            let latitude = parseFloat(parts[0]);
            let longitude = parseFloat(parts[1]);

            getMunicipalityAndDepartmentByCoordinatesEdit(latitude, longitude);
        });

        function getMunicipalityAndDepartmentByCoordinates(latitude, longitude) {
            $.ajax({
                url: '/ServiceDesk/GetMunicipalityAndDepartmentByCoordinates',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    latitude: latitude,
                    longitude: longitude
                }),
                success: function (response) {
                    if (response.success) {
                        loadMunicipalitySelectByStateAsync("selectMunicipality", response.idState)
                            .then(function () {
                                $("#selectState").val(response.idState);
                                $("#selectMunicipality").val(response.idMunicipality);

                                updateAndShowToast(
                                    'Coordenadas encontradas',
                                    new Date().toLocaleTimeString(),
                                    `Municipio: ${response.municipality}`
                                );
                            });
                    } else {
                        updateAndShowToast(
                            'Error de coordenadas',
                            new Date().toLocaleTimeString(),
                            response.message
                        );

                        $("#selectState").val("");
                        $("#selectMunicipality").val("");
                    }
                },
                error: function (xhr, status, error) {
                    updateAndShowToast(
                        'Error del servidor',
                        new Date().toLocaleTimeString(),
                        'No se pudo obtener la ubicación: ' + error
                    );

                    $("#selectState").val("");
                    $("#selectMunicipality").val("");
                }
            });
        }

        function getMunicipalityAndDepartmentByCoordinatesEdit(latitude, longitude) {
            $.ajax({
                url: '/ServiceDesk/GetMunicipalityAndDepartmentByCoordinates',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    latitude: latitude,
                    longitude: longitude
                }),
                success: function (response) {
                    if (response.success) {
                        loadMunicipalitySelectByStateAsync("selectMunicipalitye", response.idState)
                            .then(function () {
                                $("#selectStatee").val(response.idState);
                                $("#selectMunicipalitye").val(response.idMunicipality);

                                updateAndShowToast(
                                    'Coordenadas encontradas',
                                    new Date().toLocaleTimeString(),
                                    `Municipio: ${response.municipality}`
                                );
                            });
                    } else {
                        updateAndShowToast(
                            'Error de coordenadas',
                            new Date().toLocaleTimeString(),
                            response.message
                        );

                        $("#selectStatee").val("");
                        $("#selectMunicipalitye").val("");
                    }
                },
                error: function (xhr, status, error) {
                    updateAndShowToast(
                        'Error del servidor',
                        new Date().toLocaleTimeString(),
                        'No se pudo obtener la ubicación: ' + error
                    );

                    $("#selectStatee").val("");
                    $("#selectMunicipalitye").val("");
                }
            });
        }

        /**
         * Carga el select de municipios de forma asincrona
         */
        function loadMunicipalitySelectByStateAsync(elementId, stateId) {
            return $.get("/Common/GetMunicipalitiesByStateId", { stateId: stateId })
                .done(function (data) {
                    $("#" + elementId).empty();
                    $("#" + elementId).append("<option selected value=''>-- Seleccione un item --</option>");
                    $.each(data, function (index, row) {
                        $("#" + elementId).append("<option value='" + row.idMunicipality + "'>" + row.name + "</option>");
                    });
                })
                .fail(function (error) {
                    console.error("Error al cargar las municipalidades:", error);
                });
        }

        function loadMunicipalitySelectByState(elementId, stateId) {
            // Obtener las municipalidades por el ID del estado
            $.get("@Url.Action("GetMunicipalitiesByStateId", "Common")", { stateId: stateId }, function (data) {
                // Limpiar el select
                $("#" + elementId).empty();

                $("#" + elementId).append("<option selected value=''>-- Seleccione un item --</option>");
                // Agregar las opciones de municipios
                $.each(data, function (index, row) {
                    $("#" + elementId).append("<option value='" + row.idMunicipality + "'>" + row.name + "</option>");
                });
            }).fail(function (error) {
                console.error("Error al cargar las municipalidades:", error);
            });
        }

        function updateAndShowToast(title, time, message) {
            // Actualizar el contenido del toast
            $('#toast-title').text(title);
            $('#toast-time').text(time);
            $('#toast-message').text(message);

            // Mostrar el toast
            let toastElement = $('#toast-ticket-detail')[0];
            let myToast = new bootstrap.Toast(toastElement);

            // Asignar zIndex al toast
            $(toastElement).css('z-index', 1057);

            myToast.show();
        }

        function validateFactibility(idFactibility, ticket) {
            idFactibilitySelected = idFactibility; // se guarda globalmente
            selectedTicket = ticket;  // se guarda globalmente
            $('#modalTicket').text(ticket);
            $('#modalApproveReject').modal('show');
        }

        function approveFactibility(id, ticket, comment) {
            $.ajax({
                url: "/Indicadores/ApproveRejectFeasibility",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    feasibilityId: id,
                    ticket: ticket,
                    approve: true,
                    comment: comment
                }),
                success: function (response) {
                    Swal.fire({
                        title: response.tipo === "success" ? "Aprobación" : "Error",
                        text: response?.mensaje ?? "Feasibility approved successfully",
                        icon: response?.tipo ?? "warning"
                    });

                    $("#factibilidadesTable").DataTable().ajax.reload();
                },
                error: function () {
                    Swal.fire("Error", "Could not approve this feasibility.", "error");
                }
            });
        }

        function rejectFactibility(id, ticket, comment) {
            $.ajax({
                url: "/Indicadores/ApproveRejectFeasibility",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    FeasibilityId: id,
                    ticket: ticket,
                    approve: false,
                    comment: comment
                }),
                    success: function (response) {
                    Swal.fire({
                        title: response?.tipo === "success" ? "Rechazo" : "Error",
                        text: response?.mensaje ?? "Unexpected response",
                        icon: response?.tipo ?? "warning"
                    });
                    $("#factibilidadesTable").DataTable().ajax.reload();
                },
                error: function () {
                    Swal.fire("Error", "Could not reject this feasibility.", "error");
                }
            });
        }

    </script>
}
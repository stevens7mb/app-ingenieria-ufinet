@{
    Layout = "_Layout";
}

<link rel="stylesheet" type="text/css" href="~/Template/app-assets/vendors/css/tables/datatable/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="~/Template/app-assets/vendors/css/tables/datatable/responsive.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.3.2/css/buttons.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="~/Template/app-assets/vendors/css/tables/datatable/buttons.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="~/Template/app-assets/vendors/css/tables/datatable/rowGroup.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="~/Template/app-assets/vendors/css/forms/select/select2.min.css">
<link href="~/css/jquery.loadingmodal.css" rel="stylesheet" />
<!-- model DisosaIris27.Models.Dashboard.DashboardModel-->
<!-- BEGIN: Vendor CSS-->
<link href="~/Template/app-assets/vendors/css/charts/apexcharts.css" rel="stylesheet" />
<!-- END: Vendor CSS-->
<!-- BEGIN: Page CSS-->
<link href="~/Template/app-assets/css/pages/dashboard-ecommerce.css" rel="stylesheet" />
<link href="~/Template/app-assets/css/plugins/charts/chart-apex.css" rel="stylesheet" />

@*<style>
    div#div-medal {
        height: max-content;
    }
</style>*@


<!-- END: Page CSS-->
<!-- Dashboard Ecommerce Starts -->
<section id="dashboard-ecommerce">
    <div class="row match-height">
        <div class="col-xl-8 col-md-6 col-12" id="div-medal">
            <div class="row">
                <div class="col-md-4">
                    <label>Año: </label>
                    <div class="mb-1">
                        <input type="number" id="Anio" name="Anio" placeholder="Año a Consultar" class="form-control">
                    </div>
                </div>
                <div class="col-md-4">
                    <label>Mes Desde: </label>
                    <div class="mb-1">
                        <select class="form-select col-md-12" id="selectMesDesde" name="selectMesDesde">
                            <option value="0">Seleccione una opción</option>
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <label>Mes Hasta: </label>
                    <div class="mb-1">
                        <select class="form-select col-md-12" id="selectMesHasta" name="selectMesHasta">
                            <option value="0">Seleccione una opción</option>
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-8">
                </div>
                <div class="col-md-4">
                    <label></label>
                    <div class="mb-1">
                        <button type="button" class="btn btn-primary" id="btnDatosDashboard">Consultar</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Medal Card -->
        <div class="col-xl-4 col-md-6 col-12" id="div-medal">
            <div class="card card-congratulation-medal">
                <div class="card-body">
                    <h5><span id="nombreKAM"></span></h5>
                    <p class="card-text font-small-3">KAM con mas Factibilidades</p>
                    <h3 class="mb-75 mt-2 pt-50">
                        <a href="#" id="cantidadKAM"></a>
                    </h3>
                    <img src="~/Template/app-assets/images/illustration/badge.svg" class="congratulation-medal" alt="Medal Pic" />
                </div>
            </div>
        </div>
        <!--/ Medal Card -->
    </div>
    <div class="row match-height">
        <!-- Statistics Card -->
        <div class="col-xl-12 col-md-6 col-12">
            <div class="card card-statistics">
                <div class="card-header">
                    <h4 class="card-title">Estadísticas</h4>
                    <div class="d-flex align-items-center">
                        <p class="card-text font-small-2 me-25 mb-0">Estadísticas Generales Factibilidad</p>
                    </div>
                </div>
                <div class="card-body statistics-body">
                    <div class="row">
                        <div class="col-xl-3 col-sm-6 col-12 mb-2 mb-xl-0">
                            <div class="d-flex flex-row">
                                <div class="avatar bg-light-primary me-2">
                                    <div class="avatar-content">
                                        <i data-feather="book-open" class="avatar-icon"></i>
                                    </div>
                                </div>
                                <div class="my-auto">
                                    <h4 class="fw-bolder mb-0" id="estudiosTotales"></h4>
                                    <p class="card-text font-small-3 mb-0">Estudios Totales</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-sm-6 col-12 mb-2 mb-xl-0">
                            <div class="d-flex flex-row">
                                <div class="avatar bg-light-info me-2">
                                    <div class="avatar-content">
                                        <i data-feather="user" class="avatar-icon"></i>
                                    </div>
                                </div>
                                <div class="my-auto">
                                    <h4 class="fw-bolder mb-0" id="totalClientes"></h4>
                                    <p class="card-text font-small-3 mb-0">Clientes</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-sm-6 col-12 mb-2 mb-sm-0">
                            <div class="d-flex flex-row">
                                <div class="avatar bg-light-danger me-2">
                                    <div class="avatar-content">
                                        <i data-feather="box" class="avatar-icon"></i>
                                    </div>
                                </div>
                                <div class="my-auto">
                                    <h4 class="fw-bolder mb-0" id="cantidadTiposServicio"></h4>
                                    <p class="card-text font-small-3 mb-0">Tipos Servicio</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-sm-6 col-12">
                            <div class="d-flex flex-row">
                                <div class="avatar bg-light-success me-2">
                                    <div class="avatar-content">
                                        <i data-feather="cloud" class="avatar-icon"></i>
                                    </div>
                                </div>
                                <div class="my-auto">
                                    <h5 class="fw-bolder mb-0" id="anchoDeBanda"></h5>
                                    <p class="card-text font-small-3 mb-0">Ancho de Banda</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--/ Statistics Card -->
    </div>

    <div class="row match-height">
        <!-- Statistics Card -->
        <div class="col-xl-12 col-md-6 col-12">
            <div class="card card-statistics">
                <div class="card-header">
                    <h4 class="card-title">Sitios</h4>
                    <div class="d-flex align-items-center">
                        <p class="card-text font-small-2 me-25 mb-0">Estadísticas Generales Factibilidad</p>
                    </div>
                </div>
                <div class="card-body statistics-body">
                    <div class="row">
                        <div class="col-xl-3 col-sm-6 col-12 mb-2 mb-xl-0">
                            <div class="d-flex flex-row">
                                <div class="avatar bg-light-success me-2">
                                    <div class="avatar-content">
                                        <i data-feather="map-pin" class="avatar-icon"></i>
                                    </div>
                                </div>
                                <div class="my-auto">
                                    <h4 class="fw-bolder mb-0" id="sitiosConCobertura"></h4>
                                    <p class="card-text font-small-3 mb-0">Sitios Con Cobertura</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-sm-6 col-12 mb-2 mb-xl-0">
                            <div class="d-flex flex-row">
                                <div class="avatar bg-light-warning me-2">
                                    <div class="avatar-content">
                                        <i data-feather="map-pin" class="avatar-icon"></i>
                                    </div>
                                </div>
                                <div class="my-auto">
                                    <h4 class="fw-bolder mb-0" id="sitiosConCoberturaParcial"></h4>
                                    <p class="card-text font-small-3 mb-0">Sitios Con Cobertura Parcial</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-sm-6 col-12 mb-2 mb-sm-0">
                            <div class="d-flex flex-row">
                                <div class="avatar bg-light-danger me-2">
                                    <div class="avatar-content">
                                        <i data-feather="map-pin" class="avatar-icon"></i>
                                    </div>
                                </div>
                                <div class="my-auto">
                                    <h4 class="fw-bolder mb-0" id="sitiosSinCobertura"></h4>
                                    <p class="card-text font-small-3 mb-0">Sitios Sin Cobertura</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-sm-6 col-12">
                            <div class="d-flex flex-row">
                                <div class="avatar bg-light-info me-2">
                                    <div class="avatar-content">
                                        <i data-feather="map-pin" class="avatar-icon"></i>
                                    </div>
                                </div>
                                <div class="my-auto">
                                    <h5 class="fw-bolder mb-0" id="sitiosTotales"></h5>
                                    <p class="card-text font-small-3 mb-0">Sitios Totales</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--/ Statistics Card -->
    </div>

    <div class="row match-height">
        <!-- Transaction Card -->
        <div class="col-lg-12 col-md-6 col-12">
            <div class="card card-transaction">
                <div class="card-header">
                    <div class="col-md-12">
                        <h4 class="card-title">Ranking de Clientes</h4>
                        <div style="height: 20px">
                        </div>
                    </div>
                    @*<div class="dropdown chart-dropdown">
                    <i data-feather="more-vertical" class="font-medium-3 cursor-pointer" data-bs-toggle="dropdown"></i>
                    <div class="dropdown-menu dropdown-menu-end">
                    <a class="dropdown-item" href="#">Last 28 Days</a>
                    <a class="dropdown-item" href="#">Last Month</a>
                    <a class="dropdown-item" href="#">Last Year</a>
                    </div>
                    </div>*@
                </div>
                <div class="card-body">
                    <div class="table-responsive col-md-12">
                        <table class="table zero-configuration" id="rankingClientesTable">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Estudios Realizados</th>
                                    <th>Porcentaje</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!--/ Transaction Card -->
    </div>

    <div class="row match-height">
        <div class="col-lg-12 col-md-6 col-12">
            <div class="card card-transaction">
                <div class="card-header">
                    <div class="col-md-12">
                        <h4 class="card-title">INDICADORES DE DESEMPEÑO ANUAL(por defecto actual)</h4>
                        <div style="height: 20px">
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive col-md-12">
                        <table class="table zero-configuration" id="indicadoresDRTable">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Mes</th>
                                    <th>% Número de sitios de micro enlaces con cobertura</th>
                                    <th>% Número de sitios de micro enlaces con posible cobertura</th>
                                    <th>% Número de sitios de micro enlaces sin cobertura</th>
                                    <th>Numero de sitios totales</th>
                                    <th>Numero de estudios totales</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row match-height">
        <div class="col-lg-6 col-md-6 col-12">
            <div id="chartContainer"></div>
        </div>
        <div class="col-lg-6 col-md-6 col-12">
            <div id="chartContainerKam"></div>
        </div>
    </div>



</section>
<!-- Dashboard Ecommerce ends -->
<!-- BEGIN: Page Vendor JS-->

@section Scripts {
    <!-- Bootstrap datatable -->
    <script src="~/Template/app-assets/vendors/js/tables/datatable/jquery.dataTables.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/dataTables.bootstrap5.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/dataTables.responsive.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/responsive.bootstrap5.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/datatables.checkboxes.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/datatables.buttons.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/jszip.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/pdfmake.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/vfs_fonts.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/buttons.html5.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/buttons.print.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/dataTables.rowGroup.min.js"></script>
    <!-- end Bootstrap datatable -->
    <script src="~/Template/app-assets/vendors/js/forms/select/select2.full.min.js"></script>
    <script src="~/Template/app-assets/js/scripts/forms/form-select2.js"></script>
    <script src="~/Template/app-assets/vendors/js/forms/validation/jquery.validate.min.js"></script>
    <!-- Mensaje cargando-->
    <script src="~/js/jquery.loadingModal.js"></script>
    <!-- Alertas-->
    <script src="~/js/sweetalert2.all.min.js"></script>
    <!-- Graficas-->
    <script src="~/js/jquery.canvasjs.min.js"></script>

@*<script src="~/Template/app-assets/js/scripts/pages/dashboard-ecommerce.js"></script>*@

<script>
    
    function cargarDashboard(){
        //mensaje carga
        $('body').loadingModal({
            position: 'auto',
            text: 'Cargando',
            color: '#fff',
            opacity: '0.7',
            backgrundColor: 'rgb(0,0,0)',
            animation: 'doubleBounce'
        });

        var anio = $("#Anio").val();
        var mesDesde = $("#selectMesDesde").val();
        var mesHasta = $("#selectMesHasta").val();

        var parametros = JSON.stringify({ 
            Anio: anio == "" | anio == NaN ? 0 : parseInt(anio), 
            MesDesde: mesDesde == "" | mesDesde == NaN ? 0 : parseInt(mesDesde),
            MesHasta: mesHasta == "" | mesHasta == NaN ? 0 : parseInt(mesHasta)
        });

        $.ajax({
            url: "@Url.Action("DatosDashboard", "Indicadores")",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            data: parametros,
            dataType: "json",
            success: function (result) {
                try {
                    console.log(result)
                    $("#estudiosTotales").text(result.cantidadEstudiosTotales);
                    $("#nombreKAM").text(result.nombreKam);
                    $("#cantidadKAM").text(result.cantidadEstudiosKam.toLocaleString());
                    $("#sitiosTotales").text(result.sitiosTotales.toLocaleString());
                    $("#sitiosConCobertura").text(result.sitiosConCobertura.toLocaleString());
                    $("#sitiosConCoberturaParcial").text(result.sitiosConCoberturaParcial.toLocaleString());
                    $("#sitiosSinCobertura").text(result.sitiosSinCobertura.toLocaleString());
                    $("#totalClientes").text(result.rankingClientes.length.toLocaleString());
                    $("#cantidadTiposServicio").text(result.cantidadTiposServicio);
                    $("#anchoDeBanda").text(result.anchoDeBanda.toLocaleString() + ' Mbps');
                    if (result.rankingClientes.length > 0) {
                        cargarDatatableRanking(result.rankingClientes);
                    }
                    else{
                        if ($.fn.dataTable.isDataTable('#rankingClientesTable')) {
                            $('#rankingClientesTable').DataTable().clear(); //se limpia tabla
                            $('#rankingClientesTable').DataTable().draw(); //se llena con datos
                        }
                    }
                    if (result.rankingClientesGrafica.length > 0) {
                        $("#chartContainer").show();
                        cargarPieClientes(result.rankingClientesGrafica);
                    }
                    else{
                        $("#chartContainer").hide();
                    }
                    if (result.rankingKamsGrafica.length > 0) {
                        $("#chartContainerKam").show();
                        cargarBarKam(result.rankingKamsGrafica);
                    }
                    else
                    {
                        $("#chartContainerKam").hide();
                    }
                    if (result.indicadoresDesemp.length > 0) {
                        cargarDatatableIndicadoresDR(result.indicadoresDesemp);
                    }
                    else{
                        if ($.fn.dataTable.isDataTable('#indicadoresDRTable')) {
                            $('#indicadoresDRTable').DataTable().clear(); //se limpia tabla
                            $('#indicadoresDRTable').DataTable().draw(); //se llena con datos
                        }
                    }
                } catch (error) {
                    console.error(error);
                    $('body').loadingModal('destroy');
                    // Expected output: ReferenceError: nonExistentFunction is not defined
                    // (Note: the exact output may be browser-dependent)
                }
                //hidemodal loading
                $('body').loadingModal('destroy');
            },
            error: function (result) {
                Swal.fire({
                    title: 'Error al obtener datos',
                    text: result.Mensaje == null ? "Error en servidor" : result.Mensaje,
                    icon: "error"
                })
                //hidemodal loading
                $('body').loadingModal('destroy');

            }
        });
    }

    function cargarDatatableRanking(datatable){
        if ($.fn.dataTable.isDataTable('#rankingClientesTable')) {
            $('#rankingClientesTable').DataTable().clear(); //se limpia tabla
            $('#rankingClientesTable').DataTable().rows.add(datatable).draw(); //se llena con datos
        }
        else { //primera instancia tabla
            $('#rankingClientesTable').DataTable({
                "language": { "url": "https://cdn.datatables.net/plug-ins/1.12.1/i18n/es-ES.json" },
                data: datatable,
                "order": [[1, "desc"]],
                searching: false,
                columns: [
                    {
                        'defaultContent': null,
                        'render': function (data, type, row) {
                            return '<div class="d-flex"> <button disabled type="button" class="btn btn-icon btn-info mx-1" id="' + row.cliente + '" data-toggle="tooltip" data-placement="left" title="Cliente"> <i data-feather="user"></i></i> </button> ' + row.cliente + ' </div>'
                        }
                    },
                    { "data": "cantidadEstudios", render: $.fn.dataTable.render.number(',', '.', 0) },
                    {
                        'defaultContent': null,
                        'render': function (data, type, row) {
                            return row.porcentaje + '%'
                        }
                    },
                ],
                drawCallback: function (settings) {
                    feather.replace();
                }
            });
        }
    }

    $("#btnDatosDashboard").click(function(){
        cargarDashboard();
    }); 

    function cargarPieClientes(ranking){
        var options = {
            animationEnabled: true,
            title: {
                text: "TOP 10 Clientes Estudios"
            },
            data: [{
                type: "doughnut",
                innerRadius: "40%",
                showInLegend: true,
                legendText: "{label}",
                indexLabel: "{label}: #percent%",
                dataPoints: [
                    { label: ranking[0].cliente, y: ranking[0].cantidadEstudios },
                    { label: ranking[1].cliente, y: ranking[1].cantidadEstudios },
                    { label: ranking[2].cliente, y: ranking[2].cantidadEstudios },
                    { label: ranking[3].cliente, y: ranking[3].cantidadEstudios },
                    { label: ranking[4].cliente, y: ranking[4].cantidadEstudios },
                    { label: ranking[5].cliente, y: ranking[5].cantidadEstudios },
                    { label: ranking[6].cliente, y: ranking[6].cantidadEstudios },
                    { label: ranking[7].cliente, y: ranking[7].cantidadEstudios },
                    { label: ranking[8].cliente, y: ranking[8].cantidadEstudios },
                    { label: ranking[9].cliente, y: ranking[9].cantidadEstudios }
                ]
            }]
        };
        $("#chartContainer").CanvasJSChart(options);
    }

    function cargarBarKam(ranking) {
        var options = {
            animationEnabled: true,
            title: {
                text: "TOP 10 KAMS"
            },
            data: [{
                type: "column",
                dataPoints: [
                    { label: ranking[0].kam, y: ranking[0].cantidadEstudios },
                    { label: ranking[1].kam, y: ranking[1].cantidadEstudios },
                    { label: ranking[2].kam, y: ranking[2].cantidadEstudios },
                    { label: ranking[3].kam, y: ranking[3].cantidadEstudios },
                    { label: ranking[4].kam, y: ranking[4].cantidadEstudios },
                    { label: ranking[5].kam, y: ranking[5].cantidadEstudios },
                    { label: ranking[6].kam, y: ranking[6].cantidadEstudios },
                    { label: ranking[7].kam, y: ranking[7].cantidadEstudios },
                    { label: ranking[8].kam, y: ranking[8].cantidadEstudios },
                    { label: ranking[9].kam, y: ranking[9].cantidadEstudios }
                ]
            }]
        };
        $("#chartContainerKam").CanvasJSChart(options);
    }

    function cargarDatatableIndicadoresDR(datatable) {
        if ($.fn.dataTable.isDataTable('#indicadoresDRTable')) {
            $('#indicadoresDRTable').DataTable().clear(); //se limpia tabla
            $('#indicadoresDRTable').DataTable().rows.add(datatable).draw(); //se llena con datos
        }
        else { //primera instancia tabla
            $('#indicadoresDRTable').DataTable({
                "language": { "url": "https://cdn.datatables.net/plug-ins/1.12.1/i18n/es-ES.json" },
                data: datatable,
                "order": [[0, "asc"]],
                searching: false,
                columns: [
                    { "data": "correlativo" },
                    {
                        'defaultContent': null,
                        'render': function (data, type, row) {
                            return '<div class="d-flex"> <button disabled type="button" class="btn btn-icon btn-warning mx-1" id="' + row.mes + '" data-toggle="tooltip" data-placement="left" title="Mes"> <i data-feather="calendar"></i></i> </button> ' + row.mes + ' </div>'
                        }
                    },
                    { "data": "sitiosConCoberturaP"},
                    { "data": "sitiosConCoberturaParcialP"},
                    { "data": "sitiosSinCoberturaP"},
                    { "data": "sitiosTotales" },
                    { "data": "estudiosTotales" }
                ],
                drawCallback: function (settings) {
                    feather.replace();
                }
            });
        }
    }

</script>
<!-- END: Page Vendor JS-->
}
@{
    Layout = "_Layout";
}
<!--Bootstrap Datatable-->
<link rel="stylesheet" type="text/css" href="~/Template/app-assets/vendors/css/tables/datatable/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="~/Template/app-assets/vendors/css/tables/datatable/responsive.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="~/Template/app-assets/vendors/css/tables/datatable/buttons.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="~/Template/app-assets/vendors/css/tables/datatable/rowGroup.bootstrap5.min.css">
@*<link rel="stylesheet" type="text/css" href="~/Template/app-assets/vendors/css/pickers/flatpickr/flatpickr.min.css">*@

<link rel="stylesheet" type="text/css" href="~/Template/app-assets/vendors/css/forms/select/select2.min.css">
<link href="~/css/jquery.loadingmodal.css" rel="stylesheet" />

<link rel="stylesheet" type="text/css" href="~/Template/app-assets/css/pages/app-invoice.css">

<!-- BEGIN: Content-->
<!-- Basic table -->
<section id="basic-datatable">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">LISTADO DE PI</h4>
                    <div class="col text-center">
                        <button type="button" id="addPI" name="addPI" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalAgregarPI">
                            Agregar PI
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="card-body">
                        <table class="datatables-basic table" id="pi-table">
                            <thead>
                                <tr>
                                    <th>Id PI</th>
                                    <th>NumPI</th>
                                    <th class="text-truncate">Nombre PI</th>
                                    <th>Fecha Generacion</th>
                                    <th>Estado</th>
                                    <th>Total PI</th>
                                    <th class="cell-fit">Actions</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!--/ Basic table -->

<!-- Modal Agregar PI-->
<div class="modal fade" id="modalAgregarPI" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalFullTitle">Detalle de PI</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-pi" name="form-pi">
                    <section class="invoice-add-wrapper">
                        <div class="row invoice-add">
                            <!-- Invoice Add Left starts -->
                            <div class="col-xl-9 col-md-8 col-12">
                                <div class="card invoice-preview-card">
                                    <!-- Header starts -->
                                    <div class="card-body invoice-padding pb-0">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="logo-wrapper">
                                                    <h3 class="text-primary invoice-logo">Nueva PI</h3>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label>Nombre de PI: </label>
                                                <div class="mb-1">
                                                    <input type="text" id="nombrePI" name="nombrePI" placeholder="Nombre de PI" class="form-control">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <label>Numero de PI: </label>
                                                <div class="mb-1">
                                                    <input type="text" id="numPI" name="numPI" placeholder="Numero de PI" class="form-control">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-2">
                                                <div class="mb-1">
                                                    <label class="form-label">Fecha Solicitud</label>
                                                    <input id="fechaSolicitud" name="fechaSolicitud" class="form-control" type="date" />
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="mb-1">
                                                    <label class="form-label">Fecha OC</label>
                                                    <input id="fechaOC" name="fechaOC" class="form-control" type="date" />
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="mb-1">
                                                    <label class="form-label">Fecha BodegaGT</label>
                                                    <input id="fechaBodegaSucursal" name="fechaBodegaSucursal" class="form-control" type="date" />
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="mb-1">
                                                    <label class="form-label" for="first-name-column">Total PI</label>
                                                    <input type="text" id="totalPI" name="totalPI" placeholder="Total PI" class="form-control">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="mb-1">
                                                    <label class="form-label" for="first-name-column">Incurrido</label>
                                                    <input type="text" id="incurrido" name="incurrido" placeholder="Incurrido" class="form-control">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="mb-1">
                                                    <label class="form-label" for="first-name-column">Pendiente Incurrir</label>
                                                    <input type="text" id="pendienteIncurrir" name="pendienteIncurrir" placeholder="Pendiente" class="form-control" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Header ends -->

                                    <hr class="invoice-spacing" />


                                    <div class="card-body invoice-padding">
                                        <div class="col-md-12 text-center">
                                            <button type="button" id="btn-modal-fo" class="btn btn-outline-primary col-md-3" data-bs-toggle="modal" data-bs-target="#add-new-fo-sidebar">Agregar FO</button>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="card">
                                                <div class="card-content">
                                                    <div class="card-body">
                                                        <table class="datatables-basic table" id="pi-table-fo" name="pi-table-fo">
                                                            <thead>
                                                                <tr>
                                                                    <th>ID Tipo Fibra</th>
                                                                    <th class="text-truncate">Tipo Fibra</th>
                                                                    <th>Total Fibra</th>
                                                                    <th>Total Herrajes</th>
                                                                    <th class="cell-fit">Actions</th>
                                                                </tr>
                                                            </thead>
                                                        </table>
                                                        <div id="alert-table-fo" class="alert alert-warning fade show" role="alert" style="display:none">
                                                            <strong>No hay FO</strong> Debe de haber por lo menos una fo para poder guardar la PI
                                                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="mb-2">
                                            <label for="note" class="form-label fw-bold">Comentario:</label>
                                            <textarea class="form-control" rows="2" id="comentario" name="comentario"></textarea>
                                        </div>
                                    </div>


                                </div>
                            </div>
                            <!-- Invoice Add Left ends -->
                            <!-- Invoice Add Right starts -->
                            <div class="col-xl-3 col-md-4 col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h3 class="text-primary invoice-logo">RESUMEN PI</h3>
                                        <div class="col-md-12 d-flex justify-content-center">
                                            <div class="invoice-total-wrapper">
                                                <div class="invoice-total-item">
                                                    <p class="invoice-total-title">Total Herrajes:</p>
                                                    <p class="invoice-total-amount" id="granTotalHerrajes">$0</p>
                                                </div>
                                                <div class="invoice-total-item">
                                                    <p class="invoice-total-title">Total Fibras:</p>
                                                    <p class="invoice-total-amount" id="granTotalFibras">$0</p>
                                                </div>
                                                <hr class="my-50" />
                                                <div class="invoice-total-item">
                                                    <p class="invoice-total-title">Total:</p>
                                                    <p class="invoice-total-amount" id="granTotal">$0</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Invoice Add Right ends -->
                        </div>
                    </section>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" id="btn-guardar-pi" name="btn-guardar-pi" class="btn btn-primary">Guardar PI</button>
            </div>
        </div>
    </div>
</div>
<!-- END: Modal Agregar PI-->

<!-- Add New FO Sidebar -->
<div class="modal modal-slide-in fade" id="add-new-fo-sidebar" aria-hidden="true">
    <div class="modal-dialog sidebar-lg">
        <div class="modal-content p-0">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">×</button>
            <div class="modal-header mb-1">
                <h5 class="modal-title">
                    <span class="align-middle">Agregar Bobina de FO</span>
                </h5>
            </div>
            <div class="modal-body flex-grow-1">
                <form id="form-fo" name="form-fo">
                    <div class="mb-1 position-relative">
                        <label for="customer-country" class="form-label">Seleccione Tipo de Fibra Optica</label>
                        <select class="form-select" id="selectTipoBobinaFO" name="selectTipoBobinaFO">
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-1">
                                <label class="form-label">Cantidad Fibra Mts.</label>
                                <input id="distancia" name="distancia" class="form-control" type="text" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-1">
                                <label class="form-label">Cantidad Bobinas</label>
                                <input id="cantidadBobinas" name="cantidadBobinas" class="form-control" type="text" readonly />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-1">
                                <label class="form-label">Distancia Bobina</label>
                                <input id="distanciaBobina" name="distanciaBobina" class="form-control" type="text" readonly />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-1">
                                <label class="form-label">Precio por Metro</label>
                                <input id="precioUnidadMedida" name="precioUnidadMedida" class="form-control" type="text" readonly />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="card">
                            <div class="card-content">
                                <div class="card-body">
                                    <div class="col-md-12 text-center">
                                        <div class="row">
                                            <div class="col-md-3 mx-auto">
                                                <div class="mb-1">
                                                    <label class="form-label">Costo Total Fibra</label>
                                                    <input id="totalBobina" name="totalBobina" class="form-control" type="text" readonly />
                                                </div>
                                            </div>
                                            <div class="col-md-3 mx-auto">
                                                <div class="mb-1">
                                                    <label class="form-label">Total Herrajes</label>
                                                    <input id="totalHerrajes" name="totalHerrajes" class="form-control" type="text" readonly />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="pi-table-herraje-div">
                                        <table class="datatables-basic table" id="pi-table-herraje" style="display: none">
                                            <thead>
                                                <tr>
                                                    <th>ID Tipo Herraje</th>
                                                    <th class="text-truncate">Tipo Herraje</th>
                                                    <th>Precio</th>
                                                    <th>Formula</th>
                                                    <th>Cantidad</th>
                                                </tr>
                                            </thead>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer mb-1">
                <div class="mb-1 d-flex flex-wrap mt-2">
                    <button type="button" class="btn btn-primary me-1" id="btn-add-fo">Agregar</button>
                    <button type="button" id="add-fo-modal" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- /Add New Customer Sidebar -->

<!-- END: Content-->

@section Scripts {
    <!-- Bootstrap datatable -->
    <script src="~/Template/app-assets/vendors/js/tables/datatable/jquery.dataTables.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/dataTables.bootstrap5.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/dataTables.responsive.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/responsive.bootstrap5.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/datatables.checkboxes.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/datatables.buttons.min.js"></script>
    @*<script src="~/Template/app-assets/vendors/js/tables/datatable/jszip.min.js"></script>*@
    @*<script src="~/Template/app-assets/vendors/js/tables/datatable/pdfmake.min.js"></script>*@
    @*<script src="~/Template/app-assets/vendors/js/tables/datatable/vfs_fonts.js"></script>*@
    <script src="~/Template/app-assets/vendors/js/tables/datatable/buttons.html5.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/buttons.print.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/tables/datatable/dataTables.rowGroup.min.js"></script>
@*    <script src="~/Template/app-assets/vendors/js/pickers/flatpickr/flatpickr.min.js"></script>*@
    <!-- end Bootstrap datatable -->
    <script src="~/Template/app-assets/vendors/js/forms/select/select2.full.min.js"></script>
    <script src="~/Template/app-assets/vendors/js/forms/validation/jquery.validate.min.js"></script>
    <!-- Mensaje cargando-->
    <script src="~/js/jquery.loadingModal.js"></script>
    <!-- Alertas-->
    <script src="~/js/sweetalert2.all.min.js"></script>

    <!-- Agregar page-->
    <script src="~/Template/app-assets/vendors/js/forms/repeater/jquery.repeater.min.js"></script>
    <!-- END: Page Vendor JS-->
@*    <script src="~/Template/app-assets/js/scripts/pages/app-invoice.js"></script>*@

    <script>
        //DEFINICIONES Y VARIABLES
        var distanciaBobina = 0;
        var precioBobinaMetro = 0;
        var cantidadBobinas = 0;
        var totalBobina = 0;
        var totalHerrajes = 0;
        var herrajesResponse = [];
        var herrajes = [];
        var herrajesDataTable = [];
        var fibras = [];
        var modoEditarModalFO = false;
        var fibraEditar = [];

        function herraje(idTipoHerraje, cantidadHerrajes, precioUnitarioHerraje) {
            this.idTipoHerraje = idTipoHerraje,
            this.cantidadHerrajes = cantidadHerrajes,
            this.precioUnitarioHerraje = precioUnitarioHerraje
        }

        function fibra(idTipoBobinaFO, tipoBobinaFO, distanciaPIDetalle, distanciaPIBobina, cantidadBobinas, precioUnitario, totalDetalleFOPI, totalHerrajes, herrajes, herrajesDataTable){
            this.idTipoBobinaFO = idTipoBobinaFO,
            this.tipoBobinaFO = tipoBobinaFO,
            this.distanciaPIDetalle = distanciaPIDetalle,
            this.distanciaPIBobina = distanciaPIBobina
            this.cantidadBobinas = cantidadBobinas,
            this.precioUnitario = precioUnitario,
            this.totalDetalleFOPI = totalDetalleFOPI,
            this.totalHerrajes = totalHerrajes
            this.herrajes = herrajes,
            this.herrajesDataTable = herrajesDataTable
        }

        function encabezado(numPI, nombrePI, fechaSolicitud, fechaOC, fechaBodegaSucursal, totalPIEncabezado, incurrido, pendienteIncurrir, totalPIFO, totalPIHerrajes, totalPI, comentarioPI ){
            this.numPI = numPI,
            this.nombrePI = nombrePI,
            this.fechaSolicitud = fechaSolicitud,
            this.fechaOC = fechaOC,
            this.fechaBodegaSucursal = fechaBodegaSucursal,
            this.totalPIEncabezado = totalPIEncabezado,
            this.incurrido = incurrido,
            this.pendienteIncurrir = pendienteIncurrir,
            this.totalPIFO = totalPIFO,
            this.totalPIHerrajes = totalPIHerrajes,
            this.totalPI = totalPI,
            this.comentarioPI = comentarioPI
        }

        //Cargar Pagina
        $(document).ready(function () {

            $('#pi-table').DataTable({
                "language": { "url": "https://cdn.datatables.net/plug-ins/1.12.1/i18n/es-ES.json" },
                "dom": 'rtip',
                "pageLength": 5,
                "ajax": {
                    "url": "@Url.Action("ListadoPIGeneradas", "PI")",
                    "type": "GET",
                    "dataType": "json"
                },
                "order": [[0, "desc"]],
                columns: [
                    { "data": "idPIResumenCompra" },
                    { "data": "numPI" },
                    { "data": "nombrePI" },
                    { "data": "fechaGeneracion" },
                    { "data": "estadoPI" },
                    //{
                    //    "render": function (data, type, row) {
                    //        return row.moneda + row.precio
                    //    }
                    //},
                    { "data": "totalPI" },
                    {
                        'defaultContent': null,
                        'render': function (data, type, row) {
                            return '<div class="d-flex"> <button type="button" class="btn btn-icon btn-info mx-1" id="' + row.idPIResumenCompra + '" onclick="detallesPI(this.id)" data-toggle="tooltip" data-placement="left" title="Ver"> <i data-feather="eye"></i></i> </button> <button type="button" class="btn btn-icon btn-danger mx-1" id="' + row.idPIResumenCompra + '" onclick="eliminarPI(this.id)" data-toggle="tooltip" data-placement="left" title="Eliminar"> <i data-feather="trash"></i> </button> </div>'
                        }
                    }
                ],
                drawCallback: function (settings) {
                    feather.replace();
                }
            });

            $('#pi-table-fo').DataTable({
                "language": { "url": "https://cdn.datatables.net/plug-ins/1.12.1/i18n/es-ES.json" },
                "dom": 'rtip',
                "pageLength" : 5,
                "data" : fibras,
                "order": [[0, "desc"]],
                columns: [
                    { "data": "idTipoBobinaFO" },
                    { "data": "tipoBobinaFO" },
                    { "data": "totalDetalleFOPI" },
                    { "data": "totalHerrajes" },
                    {
                        'defaultContent': null,
                        'render': function (data, type, row) {
                            return '<div class="d-flex"> <button type="button" class="btn btn-icon btn-warning mx-1" id="' + row.idTipoBobinaFO + '" onclick="detallesFO(this.id)" data-toggle="tooltip" data-placement="left" title="Modificar"> <i data-feather="edit"></i></i> </button> <button type="button" class="btn btn-icon btn-danger mx-1" id="' + row.idTipoBobinaFO + '" onclick="eliminarFO(this.id)" data-toggle="tooltip" data-placement="left" title="Eliminar"> <i data-feather="trash"></i> </button> </div>'
                        }
                    }
                ],
                drawCallback: function (settings) {
                    feather.replace();
                }
            });

            cargarSelect();

        });

        function cargarSelect(){
            //Tipos de Bobina de FO
            $.get("@Url.Action("ListaTiposDeBobinaFO","Parametrization")", function (data) {

                $("#selectTipoBobinaFO").empty();

                $.each(data, function (index, row) {
                    $("#selectTipoBobinaFO").append("<option value='" + row.idTipoBobinaFO + "'>" + row.tipoBobinaFODesc + "</option>")

                });
                $("#selectTipoBobinaFO").append("<option selected disabled hidden value='0'>" + "Por Favor Seleccione Tipo de Bobina de FO" + "</option>");
            });
        }

        $("#incurrido").blur(function () {
            var total = $("#totalPI").val();
            var incurrido = $("#incurrido").val();
            
            if(total != null && incurrido != null){
                $("#pendienteIncurrir").val(total - incurrido);
            }
        })

        //FUNCIONES MODAL AGREGAR FO
        //Select cargar datos de fo
        $('#selectTipoBobinaFO').on('change', function () {
            var parametros = JSON.stringify({ idTipoBobinaFO: $("#selectTipoBobinaFO").val() });

            $.ajax({
                url: "@Url.Action("ObtenerTipoBobinaFO", "PI")",
                type: "POST",
                contentType: "application/json; charset=utf-8",
                data: parametros,
                dataType: "json",
                success: function (result) {
                    $("#distanciaBobina").val(result.distanciaBobina);
                    $("#precioUnidadMedida").val(result.precio);
                    //Se guarda en variables para utilizar 
                    distanciaBobina = 0;
                    precioBobinaMetro = 0;
                    distanciaBobina = result.distanciaBobina;
                    precioBobinaMetro = result.precio;
                },
                error: function (result) {
                    //show Alert
                    Swal.fire({
                        title: "HA OCURRIDO UN ERROR",
                        text: "Error en el Servidor" + result.responseText,
                        icon: "error"
                    })
                }
            });
        });

        function resetModalFO() {
            //Se asignan valores a vista
            $("#selectTipoBobinaFO").val(0);
            $("#distancia").val("");
            $("#precioUnidadMedida").val("");
            $("#cantidadBobinas").val("");
            $("#distanciaBobina").val("");
            $("#totalBobina").val("");
            $("#totalHerrajes").val("");
             //se limpia tabla
            if ($.fn.dataTable.isDataTable('#pi-table-herraje')) {
                $('#pi-table-herraje').DataTable().clear().draw();
            }
            $('#pi-table-herraje-div').hide();
        }

        //al abrir modal resetear fo
        $('#btn-modal-fo').on('click', function() {
            modoEditarModalFO = false; //modo editar desactivado
            resetModalFO();
        });

        //Traer datos de calculo de herrajes y totales
        $("#distancia").blur(function () {
            if ($("#selectTipoBobinaFO").val() != null && $("#distancia").val() != null && $("#distancia").val() > 0) {
                var parametros = JSON.stringify
                    (
                        {
                            idTipoBobinaFO: $("#selectTipoBobinaFO").val(),
                            distancia: $("#distancia").val(),
                            distanciaBobina: $("#distanciaBobina").val(),
                            precio: $("#precioUnidadMedida").val()
                        }
                    );

                $.ajax({
                    url: "@Url.Action("CalcularBobinaHerrajes", "PI")",
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    data: parametros,
                    dataType: "json",
                    success: function (result) {
                        $("#cantidadBobinas").val(result.cantidadBobinas);
                        cantidadBobinas = 0;
                        cantidadBobinas = result.cantidadBobinas;
                        //Cargar herrajes en tabla
                        $("#pi-table-herraje").show();
                        $('#pi-table-herraje-div').show();
                        if ( $.fn.dataTable.isDataTable('#pi-table-herraje')) {

                            $('#pi-table-herraje').DataTable().clear(); //se limpia tabla
                            $('#pi-table-herraje').DataTable().rows.add(result.herrajes).draw(); //se llena con datos
                        }
                        else{ //primera instancia tabla
                            $('#pi-table-herraje').DataTable({
                                "language": { "url": "https://cdn.datatables.net/plug-ins/1.12.1/i18n/es-ES.json" },
                                "dom": 'rtip',
                                "pageLength": 5,
                                "data": result.herrajes,
                                "order": [[0, "desc"]],
                                autoWidth: false,
                                retrieve: true,
                                columns: [
                                    { "data": "idTipoHerraje" },
                                    { "data": "tipoHerraje" },
                                    { "data": "precio" },
                                    { "data": "formula" },
                                    {
                                        "render": function (data, type, row) {
                                            return 0 + row.formulaOut
                                        }
                                    }
                                ],
                                columnDefs: [
                                    { width: "5%", targets: 0 }
                                ],
                            });
                        }  
                        //termina cargar herrajes tabla
                        //asigna totales
                        $("#totalBobina").val(result.totalBobina);
                        $("#totalHerrajes").val(result.totalHerrajes);
                        //guarda en variables globales 
                        totalBobina = 0;
                        totalHerrajes = 0;
                        totalBobina = result.totalBobina;
                        totalHerrajes = result.totalHerrajes;
                        //guardar en objeto para almacenar herrajes de fo
                        herrajesResponse = [];
                        herrajesResponse = result.herrajes;
                    },
                    error: function (result) {
                        //show Alert
                        Swal.fire({
                            title: "HA OCURRIDO UN ERROR",
                            text: "Error en el Servidor" + result.responseText,
                            icon: "error"
                        })
                    }
                });
            }
        });

        //Al cambiar select se resetea tabla
        $("#selectTipoBobinaFO").change(function () {
            $('#pi-table-herraje').hide();
            $('#distancia').val("");
            $('#cantidadBobinas').val("");
            $('#totalBobina').val("");
            $('#totalHerrajes').val("");
        });

        //AGREGAR FO
        //Validacion de formulario de fo
        $("#form-fo").validate({
            rules: {
                selectTipoBobinaFO: "required",
                distancia: "required",
                cantidadBobinas: "required",
                distanciaBobina: "required",
                precioUnidadMedida: "required",
                totalBobina: "required",
                totalHerrajes: "required",
                table_required: {
                    required: function () {
                        return $('#pi-table-herraje').DataTable().data().any();
                    }
                }

            },
            messages: {
                selectTipoBobinaFO: "Seleccione Bobina",
                distancia: "Seleccione Cantidad",
                cantidadBobinas: "Requerido",
                distanciaBobina: "Requerido",
                precioUnidadMedida: "Requerido",
                totalBobina: "Requerido",
                totalHerrajes: "Requerido",
                table_required : "Herrajes vacíos"
            },
            submitHandler: function (form) {
                event.preventDefault();
                guardarFO();
            }
        });
        //Validacion formulario fo al dar click
        $('#btn-add-fo').on('click', function() {
            if (!$("#form-fo").validate()) { // Not Valid
                return false;
            } else {
                $("#form-fo").submit()
            }
        });

        //Guardar fo con detalle de herraje y mostrar en datatable
        function guardarFO() {
            //Se arma objeto para herrajes
            herrajes = [];//reset object
            herrajesDataTable = [];
            herrajesDataTable = herrajesResponse;
            herrajesResponse.forEach(function(current, index, array){
                let herrajeLocal = new herraje(
                    current.idTipoHerraje,
                    current.formulaOut,
                    current.precio
                );

                //Se agrega a lista de herrajes
                herrajes.push(herrajeLocal);
            });

            //Se arma objeto para fibra optica
            let fibraLocal = new fibra(
                $("#selectTipoBobinaFO").val(),
                $("#selectTipoBobinaFO option:selected").text(),
                $("#distancia").val(),
                distanciaBobina,
                cantidadBobinas,
                precioBobinaMetro,
                totalBobina,
                totalHerrajes,
                herrajes,
                herrajesDataTable
            );

            //Modo editar
            if (modoEditarModalFO == true) {
                //indice de elemento que se edita
                var indice = fibras.findIndex(fibra=> fibra.idTipoBobinaFO === fibraEditar[0].idTipoBobinaFO);
                
                //Se cambian valores
                fibras[indice] = fibraLocal;

                //Mostrar en tabla
                $('#pi-table-fo').DataTable().clear(); //se limpia tabla
                $('#pi-table-fo').DataTable().rows.add(fibras).draw(); //se llena con datos
                $('#add-fo-modal').trigger("click");
            }
            else{
                if (fibras.filter((obj) => obj.idTipoBobinaFO === fibraLocal.idTipoBobinaFO).length > 0) {
                    Swal.fire({
                        title: "AVISO FIBRA",
                        text: "Tipo de fibra optica ya existe en la lista, eliminar antes, si desea agregar",
                        icon: "warning"
                    })
                }
                else {
                    //Se agrega a objeto
                    fibras.push(fibraLocal);

                    //Mostrar en tabla
                    $('#pi-table-fo').DataTable().clear(); //se limpia tabla
                    $('#pi-table-fo').DataTable().rows.add(fibras).draw(); //se llena con datos
                    $('#add-fo-modal').trigger("click");
                }
            }

            calcularTotales();
        }

        //CARGAR DETALLES FO
        function detallesFO(id){
            //modo editar modal activado
            modoEditarModalFO = true;
            //Se obtiene fibra de la lista
            fibraEditar = [];
            fibraEditar = fibras.filter((obj) => obj.idTipoBobinaFO === id);
            //Se abre modal
            $('#add-new-fo-sidebar').modal('show');
            //Se limpia modal fo
            resetModalFO(); 
            //Se asignan valores a vista
            $("#selectTipoBobinaFO").val(fibraEditar[0].idTipoBobinaFO);
            $("#distancia").val(fibraEditar[0].distanciaPIDetalle);
            $("#cantidadBobinas").val(fibraEditar[0].cantidadBobinas);
            $("#distanciaBobina").val(fibraEditar[0].distanciaBobina);
            $("#precioUnidadMedida").val(fibraEditar[0].precioUnitario);
            $("#totalBobina").val(fibraEditar[0].totalDetalleFOPI);
            $("#totalHerrajes").val(fibraEditar[0].totalHerrajes);
            //Se colocan herrajes en tabla
            $('#pi-table-herraje').DataTable().rows.add(fibraEditar[0].herrajesDataTable).draw(); //se llena con datos
            $('#pi-table-herraje-div').show();
        }

        //ELIMINAR FO
        function eliminarFO(id){
            Swal.fire({
                title: "¿Eliminar FO?",
                text: "¿Está seguro que desea eliminar FO? con id: " + id,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Si, Eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fibras = fibras.filter((obj) => obj.idTipoBobinaFO !== id);
                    $('#pi-table-fo').DataTable().clear(); //se limpia tabla
                    $('#pi-table-fo').DataTable().rows.add(fibras).draw(); //se llena con datos
                    calcularTotales();
                }
            });
        }

        function calcularTotales(){
            //inicializan variables
            var totalHerrajes = 0;
            var totalFibras = 0;
            var total = 0;
            var totalHerrajes = 0;
            var totalFibras = 0;

            //Calculos
            fibras.forEach(function(current, index, array){
                 totalHerrajes = current.totalHerrajes + totalHerrajes;
                totalFibras = current.totalDetalleFOPI + totalFibras;
            });
            total = totalHerrajes + totalFibras; 

            //Se setea en valores de vista
            $("#granTotalHerrajes").text(totalHerrajes);
            $("#granTotalFibras").text(totalFibras);
            $("#granTotal").text(total);
        }

        //////////////////////////////////GUARDAR PI///////////////////////////////////////////////////
        //Validacion de formulario de pi
        $("#form-pi").validate({
            rules: {
                nombrePI: "required",
                numPI: "required",
                fechaSolicitud: "required",
                fechaOC: "required",
                fechaBodegaSucursal: "required",
                totalPI: "required",
                incurrido: "required",
                pendienteIncurrir: "required",
                table_required: {
                    required: function () {
                        return $('#pi-table-fo').DataTable().data().any();
                    }
                }

            },
            messages: {
                nombrePI: "Agregue un nombre para la PI",
                numPI: "Agregue num PI",
                fechaSolicitud: "Agregue fecha",
                fechaOC: "Agregue fecha",
                fechaBodegaSucursal: "Agregue fecha",
                totalPI: "Agregue total",
                incurrido: "Agregue incurrido",
                pendienteIncurrir: "Agruegue pendiente incurrir",
                table_required: "No se han agregado fibras a la PI"
            },
            submitHandler: function (form) {
                if($('#pi-table-fo').DataTable().data().any()){
                    $("#alert-table-fo").hide();
                    event.preventDefault();
                    guardarPI();
                }
                else{
                    $("#alert-table-fo").show();
                }
            }
        });
        //Validacion formulario fo al dar click
        $('#btn-guardar-pi').on('click', function () {
            if (!$("#form-pi").validate()) { // Not Valid
                return false;
            } else {
                $("#form-pi").submit()
            }
        });

        function guardarPI(){
            let header = new encabezado(
                $("#numPI").val(),
                $("#nombrePI").val(),
                $("#fechaSolicitud").val(),
                $("#fechaOC").val(),
                $("#fechaBodegaSucursal").val(),
                $("#totalPI").val(),
                $("#incurrido").val(),
                $("#pendienteIncurrir").val(),
                $("#granTotalFibras").text(),
                $("#granTotalHerrajes").text(),
                $("#granTotal").text()
            );

            var request = JSON.stringify({ "PIResumenCompraRequest": header, "PIDetalleFORequest": fibras });

            $.ajax({
                url: "@Url.Action("GuardarPI", "PI")",
                type: "POST",
                contentType: "application/json; charset=utf-8",
                data: request,
                dataType: "json",
                success: function (result) {
                    Swal.fire({
                        title: "PI GUARDADA",
                        text: "Se ha guardado correctamente la PI",
                        icon: result.result
                    })
                    $('#modalAgregarPI').modal('hide');
                },
                error: function (result) {
                    //show Alert
                    Swal.fire({
                        title: "HA OCURRIDO UN ERROR",
                        text: "Error en el Servidor" + result.responseText,
                        icon: "error"
                    })
                }
            });
        }

        //////////////////////////////////VER PI///////////////////////////////////////////////////

        //////////////////////////////////ELIMINAR PI//////////////////////////////////////////////
        function eliminarPI(id){
             Swal.fire({
                title: "¿Eliminar PI?",
                text: "¿Está seguro que desea eliminar PI? con id: " + id,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Si, Eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    //Modal Loading
                    $('body').loadingModal({
                        position: 'auto',
                        text: 'Cargando',
                        color: '#fff',
                        opacity: '0.7',
                        backgrundColor: 'rgb(0,0,0)',
                        animation: 'doubleBounce'
                    });

                    $.ajax({
                    url: "@Url.Action("EliminarPI", "PI")",
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({idResumenCompraPI: id}),
                    dataType: "json",
                    success: function (result) {
                        //show Alert
                        Swal.fire({
                            title: 'PI',
                            text: result.mensaje,
                            icon: result.tipo
                        })

                        //reload table
                        var table = $('#pi-table').DataTable();
                        table.ajax.reload();
                        //hidemodal loading
                        $('body').loadingModal('destroy');
                    },
                    error: function (result) {
                        //show Alert
                        Swal.fire({
                            title: "HA OCURRIDO UN ERROR",
                            text: "Error en el Servidor" + result.responseText,
                            icon: "error"
                        });
                        //hidemodal loading
                        $('body').loadingModal('destroy');
                    }
            });
                }
            });
        }

    </script>
}